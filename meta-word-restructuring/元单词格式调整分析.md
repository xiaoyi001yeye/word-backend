# 元单词格式调整分析文档

## 一、当前格式 vs 新格式对比

### 当前格式 (扁平结构)
```json
{
  "id": 1001,
  "word": "book",
  "phonetic": "/bʊk/",
  "definition": "A written or printed work...",
  "partOfSpeech": "noun",
  "exampleSentence": "She read a book.",
  "translation": "书；书籍",
  "difficulty": 2,
  "createdAt": "...",
  "updatedAt": "..."
}
```

### 新格式 (嵌套结构)
```json
{
  "id": 1001,
  "word": "book",
  "phonetic": {
    "uk": "/bʊk/",
    "us": "/bʊk/"
  },
  "partOfSpeech": [
    {
      "pos": "noun",
      "definitions": [
        {
          "definition": "A written or printed work...",
          "translation": "书；书籍",
          "exampleSentences": [
            {
              "sentence": "She spent the whole afternoon reading...",
              "translation": "她整个下午都在看书。"
            }
          ]
        }
      ],
      "inflection": {
        "plural": "books"
      },
      "synonyms": ["volume", "tome"],
      "antonyms": []
    }
  ]
}
```

---

## 二、受影响的功能清单

### 1. Entity 层
**文件**: `src/main/java/com/example/words/model/MetaWord.java`

**变更内容**:
- `phonetic`: String → `Phonetic` 对象 (内含 `uk`, `us` 字段)
- `partOfSpeech`: String → `List<PartOfSpeech>` 数组
- `definition`, `exampleSentence`, `translation`: 移动到 `PartOfSpeech` → `Definition` 嵌套结构中

**需要新增的内部类**:
- `Phonetic`: 包含 `uk`, `us` 两个 String 字段
- `PartOfSpeech`: 包含 `pos`, `definitions`, `inflection`, `synonyms`, `antonyms`
- `Definition`: 包含 `definition`, `translation`, `exampleSentences`
- `ExampleSentence`: 包含 `sentence`, `translation`
- `Inflection`: 包含 `plural`, `past`, `pastParticiple` 等

---

### 2. DTO 层
**文件**: `src/main/java/com/example/words/dto/MetaWordEntryDto.java`

**变更内容**:
- 导入时使用的 DTO 需要适配新格式
- `phonetic`: String → `PhoneticDto`
- `partOfSpeech`: String → `List<PartOfSpeechDto>`

**建议**: 保持向后兼容，可同时支持新旧格式

---

### 3. Repository 层
**文件**: `src/main/java/com/example/words/repository/MetaWordRepository.java`

**变更内容**:
- 现有查询方法 `findByWord`, `findByDifficulty`, `findByWordStartingWith` 可继续使用 (基于 `word` 字段)
- 如需按词性查询，需新增方法 (如 `findByPartOfSpeechPos`)
- 如需全文搜索释义内容，需新增 JSONB 查询

---

### 4. Service 层

#### MetaWordService.java
**文件**: `src/main/java/com/example/words/service/MetaWordService.java`

**变更内容**:
- `saveIfNotExists()`: 构造函数参数变更
- `saveWordIfNotExists()`: 无大影响
- `importFromFile()`: CSV 导入逻辑需要适配新结构
  - 当前: 简单 word + definition 两列
  - 建议: 扩展 CSV 格式或改为 JSON 导入
- `search()`: 搜索逻辑可能需要调整 (搜索定义内容)

#### DictionaryWordService.java
**文件**: `src/main/java/com/example/words/service/DictionaryWordService.java`

**变更内容**:
- `updateMetaWordFields()`: 需要完全重写以适配新结构
- `processWordList()`: 处理导入时需要适配新 DTO 格式

---

### 5. Controller 层
**文件**: `src/main/java/com/example/words/controller/MetaWordController.java`

**变更内容**:
- API 接口的请求/响应格式变化
- `POST /api/meta-words`: 创建/更新接口需要接受新格式
- `GET /api/meta-words/{id}`: 返回新格式
- `GET /api/meta-words/word/{word}`: 返回新格式

---

### 6. 数据库层
**文件**: `src/main/resources/db/migration/`

**变更内容**:
- 需要创建新的 Flyway 迁移脚本 `V4__restructure_meta_words.sql`
- 方案选择:
  - **方案A (推荐)**: 新增 JSONB 字段，保留旧字段做迁移，逐步迁移后删除旧字段
  - **方案B**: 新建表，老数据迁移，删除旧表

**建议采用方案A - JSONB 字段**:
```sql
-- 新增 JSONB 字段存储嵌套结构
ALTER TABLE meta_words ADD COLUMN phonetic_detail JSONB;
ALTER TABLE meta_words ADD COLUMN part_of_speech_detail JSONB;

-- 迁移数据示例 (phonetic)
UPDATE meta_words 
SET phonetic_detail = jsonb_build_object('uk', phonetic, 'us', phonetic)
WHERE phonetic IS NOT NULL;

-- 迁移数据示例 (partOfSpeech) - 简化处理
UPDATE meta_words 
SET part_of_speech_detail = jsonb_build_array(
  jsonb_build_object(
    'pos', part_of_speech,
    'definitions', jsonb_build_array(
      jsonb_build_object(
        'definition', definition,
        'translation', translation,
        'exampleSentences', jsonb_build_array(
          jsonb_build_object('sentence', example_sentence, 'translation', translation)
        )
      )
    )
  )
)
WHERE part_of_speech IS NOT NULL;
```

---

## 三、修改优先级建议

### 第一阶段: Entity + DTO + 数据库迁移
1. 创建新的嵌套结构内部类
2. 新增 JSONB 字段
3. 编写数据迁移脚本
4. 保持 API 兼容 (可选)

### 第二阶段: Service 层适配
1. 修改 `MetaWordService` 的保存/查询逻辑
2. 修改 `DictionaryWordService` 的字段更新逻辑

### 第三阶段: Controller + 测试
1. 更新 API 接口
2. 更新导入功能 (CSV → JSON 或扩展 CSV)
3. 全面测试

---

## 四、向后兼容建议

在过渡期可以:
1. API 同时支持新旧格式请求
2. 读取时优先返回新格式，旧格式数据自动转换
3. 迁移完成后逐步废弃旧字段

---

## 五、风险评估

| 风险项 | 风险等级 | 缓解措施 |
|--------|----------|----------|
| 数据迁移丢失 | 高 | 充分测试迁移脚本，先在测试环境验证 |
| API 兼容性破坏 | 中 | 提供版本化 API 或同时支持新旧格式 |
| 搜索功能影响 | 中 | 评估全文搜索需求，必要时使用 JSONB 索引 |
| 导入功能变更 | 中 | 扩展 CSV 格式或提供 JSON 导入方式 |

---

## 六、文件修改清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `model/MetaWord.java` | 重大修改 | 新增嵌套结构内部类 |
| `dto/MetaWordEntryDto.java` | 重大修改 | 适配新导入格式 |
| `service/MetaWordService.java` | 重大修改 | 适配新数据结构和导入逻辑 |
| `service/DictionaryWordService.java` | 中等修改 | 更新字段映射逻辑 |
| `controller/MetaWordController.java` | 中等修改 | API 格式变更 |
| `repository/MetaWordRepository.java` | 轻微修改 | 可能需要新增查询方法 |
| `db/migration/V4__*.sql` | 重大修改 | 数据迁移脚本 |

---

*文档创建时间: 2026-02-23*
